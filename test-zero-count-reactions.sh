#!/bin/bash

echo "ğŸš« ZERO-COUNT REACTION HIDING TEST"
echo "================================="
echo ""
echo "This test verifies that reactions with 0 count are properly hidden"
echo "from the UI and cleaned up from the database."
echo ""

echo "ğŸ“‹ SETUP:"
echo "1. Backend running: cd backend && go run main.go"
echo "2. Frontend running: cd frontend && npm run dev"
echo "3. Two browser tabs with different users logged in"
echo ""

echo "ğŸ§ª TEST SCENARIOS:"
echo ""

echo "Scenario 1: Single User Removes Own Reaction"
echo "-------------------------------------------"
echo "User A: Send message 'Test reaction removal'"
echo "User A: Add ğŸ‘ reaction to the message"
echo "âœ… Expected: Message shows ğŸ‘(1) highlighted in blue"
echo ""
echo "User A: Click the ğŸ‘ reaction again to remove it"
echo "âœ… Expected: ğŸ‘ reaction completely disappears (no ğŸ‘(0))"
echo "âœ… Expected: No reaction bubbles shown under the message"
echo ""

echo "Scenario 2: Multiple Users, One Removes Reaction"
echo "-----------------------------------------------"
echo "User A: Add ğŸ‘ reaction to the message"
echo "User B: Add â¤ï¸ reaction to the same message"
echo "âœ… Expected: Message shows ğŸ‘(1) â¤ï¸(1)"
echo ""
echo "User A: Remove their ğŸ‘ reaction"
echo "âœ… Expected: Only â¤ï¸(1) remains, ğŸ‘ completely gone"
echo "âŒ Should NOT show: ğŸ‘(0) â¤ï¸(1)"
echo ""

echo "Scenario 3: Switch Reactions (Zero Count Cleanup)"
echo "------------------------------------------------"
echo "User A: Add ğŸ˜‚ reaction"
echo "âœ… Expected: â¤ï¸(1) ğŸ˜‚(1) showing"
echo ""
echo "User B: Switch from â¤ï¸ to ğŸ˜‚"
echo "âœ… Expected: Only ğŸ˜‚(2) showing, â¤ï¸ completely gone"
echo "âŒ Should NOT show: â¤ï¸(0) ğŸ˜‚(2)"
echo ""

echo "Scenario 4: All Users Remove Same Reaction"
echo "-----------------------------------------"
echo "User A: Add ğŸ‘ reaction"
echo "User B: Add ğŸ‘ reaction"
echo "âœ… Expected: ğŸ‘(2) showing"
echo ""
echo "User A: Remove ğŸ‘ reaction"
echo "âœ… Expected: ğŸ‘(1) showing"
echo ""
echo "User B: Remove ğŸ‘ reaction"
echo "âœ… Expected: No reactions showing, ğŸ‘ completely gone"
echo "âŒ Should NOT show: ğŸ‘(0)"
echo ""

echo "Scenario 5: Page Refresh After Removals"
echo "---------------------------------------"
echo "After all the above tests, refresh both browser tabs"
echo "âœ… Expected: Only reactions with count > 0 appear"
echo "âœ… Expected: No ghost reactions with 0 count"
echo ""

echo "ğŸ” DEBUGGING CHECKS:"
echo "===================="
echo ""
echo "1. Browser Console Verification:"
echo "   Open DevTools and check message objects:"
echo "   console.log('Message reactions:', allMessages.map(m => ({id: m.id, reactions: m.reactions})));"
echo ""
echo "   âœ… Should show: reactions: {\"ğŸ˜‚\": [\"user1\", \"user2\"]}"
echo "   âŒ Should NOT show: reactions: {\"ğŸ‘\": [], \"ğŸ˜‚\": [\"user1\"]}"
echo ""

echo "2. Database Verification:"
echo "   curl 'http://localhost:8080/messages?room_id=YOUR_ROOM_ID'"
echo ""
echo "   âœ… Expected database format:"
echo "   \"reactions\": {\"ğŸ˜‚\": [\"user1\", \"user2\"]}"
echo ""
echo "   âŒ Should NOT have empty arrays:"
echo "   \"reactions\": {\"ğŸ‘\": [], \"ğŸ˜‚\": [\"user1\"]}"
echo ""

echo "3. Network Traffic Check:"
echo "   In DevTools > Network, when removing reactions:"
echo "   âœ… Should see WebSocket 'remove' events"
echo "   âœ… Should see API calls to /message/reaction/remove"
echo ""

echo "ğŸ¯ VISUAL INDICATORS:"
echo "===================="
echo ""
echo "âœ… CORRECT BEHAVIOR:"
echo "â€¢ Reactions disappear completely when count reaches 0"
echo "â€¢ Only active reactions (count > 0) are displayed"
echo "â€¢ Smooth fade-out animation when last user removes reaction"
echo "â€¢ Clean message appearance with no empty reaction bubbles"
echo ""
echo "âŒ INCORRECT BEHAVIOR:"
echo "â€¢ Showing reaction bubbles with \"0\" count"
echo "â€¢ Empty reaction arrays in browser console"
echo "â€¢ Ghost reactions appearing after page refresh"
echo "â€¢ Reaction bubbles with no users but still visible"
echo ""

echo "âš¡ REAL-TIME VERIFICATION:"
echo "========================="
echo ""
echo "1. User A removes reaction â†’ Should disappear immediately on User B's screen"
echo "2. Last user removes reaction â†’ Should disappear on all screens simultaneously"
echo "3. No flickering or temporary \"0\" counts during transitions"
echo ""

echo "ğŸ› COMMON ISSUES TO WATCH FOR:"
echo "=============================="
echo ""
echo "Issue 1: Reaction shows as \"ğŸ‘(0)\""
echo "Fix: Check frontend filter logic and backend cleanup"
echo ""
echo "Issue 2: Empty arrays in database"
echo "Fix: Verify backend RemoveReaction cleanup logic"
echo ""
echo "Issue 3: Ghost reactions after refresh"
echo "Fix: Check API response format and frontend data processing"
echo ""

echo "ğŸš€ SUCCESS CRITERIA:"
echo "==================="
echo "âœ… No reactions with 0 count displayed"
echo "âœ… Empty reaction arrays removed from database"
echo "âœ… Clean UI with only active reactions"
echo "âœ… Proper real-time updates across all users"
echo "âœ… Consistent behavior after page refresh"
echo ""

echo "Ready to test zero-count reaction hiding! ğŸ¬"
echo ""
echo "ğŸ’¡ Quick Test Command:"
echo "Add reaction â†’ Remove reaction â†’ Verify it disappears completely"
