#!/bin/bash

# Test Script: Single Reaction Per User Per Message

echo "ğŸ§ª Testing Single Reaction Per User Feature"
echo "============================================"

echo ""
echo "ğŸ“‹ Test Instructions:"
echo "1. Start your backend server: cd backend && go run main.go"
echo "2. Start your frontend: cd frontend && npm run dev"
echo "3. Open two browser windows/tabs with different users"
echo "4. Follow the test steps below"

echo ""
echo "ğŸ”§ Test Steps:"
echo ""

echo "Step 1: Send Test Messages"
echo "-------------------------"
echo "User A: Send 'Message 1: Test single reactions on this!'"
echo "User B: Send 'Message 2: Try switching reactions!'"

echo ""
echo "Step 2: Test Single Reaction Constraint"
echo "---------------------------------------"
echo "User A: Add ğŸ‘ reaction to Message 2"
echo "âœ… Verify User B sees ğŸ‘ reaction immediately"
echo ""
echo "User A: Now add â¤ï¸ reaction to the SAME Message 2"
echo "âœ… Expected: ğŸ‘ should disappear and only â¤ï¸ should show"
echo "âœ… Verify smooth animation transition (fade out ğŸ‘, fade in â¤ï¸)"
echo "âœ… Verify User B sees ONLY â¤ï¸ reaction (no ğŸ‘)"

echo ""
echo "Step 3: Test Multiple Users, Single Reactions Each"
echo "--------------------------------------------------"
echo "User B: Add ğŸ˜‚ reaction to Message 1"
echo "User A: Add ğŸ‰ reaction to Message 1"
echo "âœ… Expected: Message 1 shows both ğŸ˜‚(1) and ğŸ‰(1)"
echo "âœ… Each user should see their own reaction highlighted"

echo ""
echo "Step 4: Test Reaction Switching"
echo "-------------------------------"
echo "User B: Switch from ğŸ˜‚ to ğŸ‘ on Message 1"
echo "âœ… Expected: User B's ğŸ˜‚ disappears, ğŸ‘ appears"
echo "âœ… User A's ğŸ‰ remains unchanged"
echo "âœ… Final state: ğŸ‘(1) ğŸ‰(1)"

echo ""
echo "Step 5: Test Reaction Removal"
echo "-----------------------------"
echo "User A: Click their own ğŸ‰ reaction to remove it"
echo "âœ… Expected: ğŸ‰ disappears completely"
echo "âœ… Only User B's ğŸ‘(1) remains"

echo ""
echo "Step 6: Test Quick Reaction Bar"
echo "-------------------------------"
echo "Hover over Message 1 to show quick reaction bar"
echo "User A: Click ğŸ‘ in quick reaction bar"
echo "âœ… Expected: User B's ğŸ‘ stays, User A gets their own ğŸ‘"
echo "âœ… Display shows: ğŸ‘(2)"
echo ""
echo "User A: Click â¤ï¸ in quick reaction bar"
echo "âœ… Expected: User A's ğŸ‘ switches to â¤ï¸"
echo "âœ… Display shows: ğŸ‘(1) â¤ï¸(1)"

echo ""
echo "Step 7: Test Page Refresh Persistence"
echo "-------------------------------------"
echo "Both users: Refresh the page (F5)"
echo "âœ… Verify reactions persist after refresh"
echo "âœ… Verify each user's reaction is still highlighted correctly"

echo ""
echo "âœ… Expected Behaviors:"
echo "---------------------"
echo "â€¢ One reaction per user per message (enforced)"
echo "â€¢ Smooth animations when switching reactions"
echo "â€¢ Real-time updates across all users"
echo "â€¢ Current user's reaction is highlighted (blue)"
echo "â€¢ Quick reaction bar shows current selection"
echo "â€¢ Reaction counts are always accurate"
echo "â€¢ Reactions persist after page refresh"

echo ""
echo "ğŸ¨ Visual Indicators:"
echo "--------------------"
echo "â€¢ Current user's reaction: Blue background, blue border"
echo "â€¢ Other reactions: Gray background, gray border"
echo "â€¢ Hover effects: Scale animation, brighter colors"
echo "â€¢ Transition animations: Smooth fade in/out"
echo "â€¢ Quick bar selection: Blue background for current reaction"

echo ""
echo "âŒ What Should NOT Happen:"
echo "-------------------------"
echo "â€¢ User having multiple reactions on same message"
echo "â€¢ Reaction counts being incorrect"
echo "â€¢ Multiple users losing reactions when one user changes"
echo "â€¢ Reactions appearing/disappearing without user action"
echo "â€¢ Broken animations or flickering"

echo ""
echo "ğŸ” Debugging Checks:"
echo "-------------------"
echo "Frontend Console:"
echo "â€¢ Look for 'Error handling reaction:' messages"
echo "â€¢ Check WebSocket 'reaction' event logs"
echo "â€¢ Verify no duplicate reaction API calls"
echo ""
echo "Backend Console:"
echo "â€¢ Should see 'remove' then 'add' events when switching"
echo "â€¢ No errors in SetUserReaction function"
echo "â€¢ Proper room-based broadcasting"
echo ""
echo "Network Tab:"
echo "â€¢ POST /message/reaction/add calls should return 200"
echo "â€¢ POST /message/reaction/remove calls should return 200"

echo ""
echo "ğŸ¯ Success Criteria:"
echo "-------------------"
echo "âœ… Only one reaction per user per message"
echo "âœ… Smooth transition animations when switching"
echo "âœ… Real-time synchronization across users"
echo "âœ… Accurate reaction counts at all times"
echo "âœ… Visual highlighting of current user's reaction"
echo "âœ… Persistent state after page refreshes"
echo "âœ… Intuitive UX for reaction switching"

echo ""
echo "ğŸš€ Advanced Test Cases:"
echo "----------------------"
echo "1. Rapid Reaction Switching:"
echo "   - Quickly switch between multiple reactions"
echo "   - Verify no race conditions or state corruption"
echo ""
echo "2. Network Issues:"
echo "   - Add reaction, disconnect network, reconnect"
echo "   - Verify state synchronization on reconnection"
echo ""
echo "3. Multiple Tabs:"
echo "   - Open same user in multiple tabs"
echo "   - Change reaction in one tab"
echo "   - Verify other tabs update immediately"

echo ""
echo "Ready to test single reactions! ğŸ¬"
